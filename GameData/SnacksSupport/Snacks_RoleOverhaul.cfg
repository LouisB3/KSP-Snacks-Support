// Remove Ore -> Snack processor from all parts
// Affected: stock lab, SSPXR greenhouses

@PART:HAS[@MODULE[SnackProcessor]]:NEEDS[StationPartsExpansionRedux]:AFTER[Snacks]
{
  !MODULE[SnackProcessor] {}
}

// Remove Soil -> Snack recyclers from all parts
// Affected: all habs

@PART:HAS[@MODULE[SoilRecycler]]:NEEDS[StationPartsExpansionRedux]:AFTER[Snacks]
{
  !MODULE[SoilRecycler] {}
  !RESOURCE[Soil] {}
}

// Add Ore -> Soil processor to ISRUs

@PART[ISRU,MiniISRU]:NEEDS[StationPartsExpansionRedux]:AFTER[Snacks]
{
  @tags ^= :$: cck-lifesupport:
  MODULE
  {
    name = SnackProcessor
    ConverterName = Soil Processor
    StartActionName = Start Soil Processor
    StopActionName = Stop Soil Processor
    AutoShutdown = false
    GeneratesHeat = false
    UseSpecialistBonus = true
    UseSpecializationBonus = true
    SpecialistEfficiencyFactor = 0.1
    ExperienceEffect = ScienceSkill
    EfficiencyBonus = 1.0
    // Default rates; may need adjustment
    INPUT_RESOURCE
    {
      ResourceName = Ore
      Ratio = 0.002
      FlowMode = STAGE_PRIORITY_FLOW
      }
    INPUT_RESOURCE
    {
      ResourceName = ElectricCharge
      Ratio = 30
      FlowMode = STAGE_PRIORITY_FLOW
    }
    OUTPUT_RESOURCE
    {
      ResourceName = Soil
      Ratio = 0.001
      DumpExcess = false
      FlowMode = STAGE_PRIORITY_FLOW
    }
  }
}

// Downscale small ISRU capacity to 25% (consistent with Rational Resources)

@PART[MiniISRU]:NEEDS[StationPartsExpansionRedux]:AFTER[Snacks]
{
  @MODULE[SnackProcessor]
  {
    @INPUT_RESOURCE,*
		{
			@Ratio *= 0.25
		}
		@OUTPUT_RESOURCE,*
		{
			@Ratio *= 0.25
		}
  }
}

// Add Soil -> Snack recyclers to greenhouses

@PART[sspx-greenhouse-*]:NEEDS[StationPartsExpansionRedux]:AFTER[Snacks]
{
  @tags ^= :$: cck-lifesupport:
  // Standard settings
  MODULE
  {
    name = SoilRecycler
    ConverterName = Soil Recycler
    StartActionName = Start Soil Recycler
    StopActionName = Stop Soil Recycler
    AutoShutdown = false
    GeneratesHeat = false
    UseSpecialistBonus = true
    ExperienceEffect = ConverterSkill
    EfficiencyBonus = 1.0
    RecyclerCapacity = 4
    INPUT_RESOURCE
    {
      ResourceName = Soil
      Ratio = 0.00004630
      FlowMode = ALL_VESSEL
      }
    INPUT_RESOURCE
    {
      ResourceName = ElectricCharge
      Ratio = 3
      FlowMode = STAGE_PRIORITY_FLOW
    }
    OUTPUT_RESOURCE
    {
      ResourceName = Snacks
      Ratio = 0.00004630
      DumpExcess = false
      FlowMode = ALL_VESSEL
    }
  }
  RESOURCE
  {
    name = Soil
    amount = 0
    maxAmount = 400 // 2x standard
  }
}

// Upscale large greenhouse capacity by 50%, same as mass
// To do: make compatible with SSPXR's Snacks patch marked FINAL

@PART[sspx-greenhouse-375-1]:NEEDS[StationPartsExpansionRedux]:AFTER[Snacks]
{
  @MODULE[SoilRecycler]
  {
    @RecyclerCapacity *= 1.5
  }
  @RESOURCE[Soil]
  {
    @maxAmount *= 1.5
  }
}
